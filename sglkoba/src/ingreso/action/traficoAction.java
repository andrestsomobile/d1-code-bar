package ingreso.action;import java.io.File;import java.io.IOException;import java.sql.SQLException;import java.util.ArrayList;import java.util.Collection;import java.util.Iterator;import javax.servlet.ServletException;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import javax.servlet.http.HttpSession;import org.apache.struts.action.Action;import org.apache.struts.action.ActionForm;import org.apache.struts.action.ActionForward;import org.apache.struts.action.ActionMapping;import org.apache.struts.action.ActionMessage;import org.apache.struts.action.ActionMessages;import administracion.entity.usuario;import ingreso.control.PDFInspeccionRecibo;import ingreso.control.gstcontenedor_trafico;import ingreso.control.gstfactura_trafico;import ingreso.control.gstingreso;import ingreso.control.gstinspeccion_recibo;import ingreso.control.gstreferencia_trafico;import ingreso.control.gsttrafico;import ingreso.entity.inspeccion_recibo;import ingreso.entity.trafico;import ingreso.form.traficoForm;import maestro.control.gstcompania;import maestro.control.gstconfig_bodega;import maestro.control.gstproducto;import maestro.control.gsttransportadora;import maestro.entity.compania;import maestro.entity.transportadora;import registro.control.gstregistro_almacenamiento_detalle;import registro.form.registro_almacenamientoForm;import util.Propiedades;import util.gstenviarmail;public final class traficoAction extends Action {	public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {		traficoForm _form = (traficoForm) form;		gsttrafico control = new gsttrafico();		String opcion = request.getParameter("opcion");		opcion = opcion == null || (opcion != null && opcion.equals("")) ? "crear" : opcion;		String mensaje = "";		String destino = "trafico";		usuario usu = (usuario) request.getSession().getAttribute("usuario");		String trafusuario = usu.getusucodsx();		// opcion de activar un ingreso:		if (opcion.equals("activar")) {			trafico entity = control.gettrafico(request.getParameter("codsx"));			// miro que no este en ningun ingreso:			Collection c = new gstingreso().getlistaingresoFinalizadoByTrafico(entity.gettrafcodsx());			if (!c.isEmpty()) {				mensaje = "No puede activar el trafico si este se encuentra en uno o varios ingresos Y ESTOS YA ESTAN FINALIZADOS";				destino = "trafico";			} else {				entity.setTrafestado("TRAMITE");				// entity.settraffechacreacion( util.Fecha.getFecha());				try {					control.updatetrafico(entity);					traficoForm temp = new traficoForm();					temp.setopcion("update");					temp.llenar(entity);					request.setAttribute("traficoForm", temp);					destino = "trafico_datos";					mensaje = "Trafico Activado con exito";				} catch (SQLException e1) {					mensaje = "No se pudo Activar el Ingreso <br>" + e1.getMessage();					e1.printStackTrace();					destino = "ingreso_datos";				}			}		}		// OPCION DE set:		if (opcion.equals("set")) {			trafico entity = control.gettrafico(request.getParameter("codsx"));			traficoForm temp = new traficoForm();			temp.setopcion("update");			temp.llenar(entity);			request.setAttribute("traficoForm", temp);			request.setAttribute("trafcodsx", temp.gettrafcodsx());			destino = "trafico_datos";		}		// opcion de CREAR		if (opcion.equals("crear")) {			String trafcompania = _form.gettrafcompania();			String traffechacreacion = _form.gettraffechacreacion();			String trafdocumento = _form.gettrafdocumento();			String trafembarque = _form.gettrafembarque();			String traftransportadora = null;_form.gettraftransportadora();			String trafprocedencia = _form.gettrafprocedencia();			String traffechaarribopuerto = _form.gettraffechaarribopuerto();			String traffechapresentdta = _form.gettraffechapresentdta();			String traffechaaprobaciondta = _form.gettraffechaaprobaciondta();			String traffob = "0";// _form.gettraffob();			String trafcif = "0";// _form.gettrafcif();			String trafconsec = _form.gettrafconsec();			String trafnumerofmm = _form.gettrafnumerofmm();			String traftrm = _form.gettraftrm();			String trafnumdta = _form.gettrafnumdta();			String trafnumsobordo = _form.gettrafnumsobordo();			String traffechadescargue = _form.gettraffechadescargue();			String traffechalevante = _form.gettraffechalevante();			String traffechaingresozf = _form.gettraffechaingresozf();			String trafentregadocusia = _form.gettrafentregadocusia();			String trafobservaciones = _form.gettrafobservaciones();			String trafpesobruto = "0";// _form.gettrafpesobruto();			String traffechasobordo = _form.gettraffechasobordo();			String traforigen = _form.gettraforigen();			String trafpesoneto = "0";// _form.gettrafpesoneto();			String traffletesseguro = _form.gettraffletesseguro();			String trafestado = _form.getTrafestado();			try {				control.creartrafico(trafcompania, traffechacreacion, trafdocumento, trafembarque, traftransportadora, trafprocedencia, traffechaarribopuerto, traffechapresentdta, traffechaaprobaciondta, traffob, trafcif, trafconsec, trafnumerofmm, traftrm, trafnumdta, trafnumsobordo,						traffechadescargue, traffechalevante, traffechaingresozf, trafentregadocusia, trafobservaciones, trafpesobruto, trafusuario, traffechasobordo, traforigen, trafpesoneto, traffletesseguro, trafestado, _form.getTrafpedido(), _form.getTrafmotonave());				// lo mando para la lista de contenedores...				destino = "contenedor_trafico";				// _form.setopcion("update");				trafico entity_creada = control.gettrafico(trafcompania, trafdocumento);				_form.settrafcodsx(entity_creada.gettrafcodsx());				control.actualiar_CIF_referencias(entity_creada.gettrafcodsx());				request.setAttribute("trafcodsx", entity_creada.gettrafcodsx());				mensaje = "trafico Creado con Exito";			} catch (SQLException e) {				e.printStackTrace();				mensaje = "No se pudo Crear el trafico: <br> " + e.getLocalizedMessage();				destino = "trafico_datos";			}		}		// Opcion de update		if (opcion.equals("update")) {			try {				_form.settrafusuario(trafusuario);				// _form.settraffechacreacion( util.Fecha.getFecha());				// actualizo los datos generales								trafico entity = control.gettrafico(_form.gettrafcodsx());								control.updatetrafico(_form);				control.actualiar_CIF_referencias(_form.gettrafcodsx());								if (!entity.getTrafestado().equalsIgnoreCase(_form.getTrafestado())) { // es decir que cambia de tramite a finalizado					gstenviarmail gem = new gstenviarmail();					gstcompania gcom = new gstcompania();					compania entidad_com = gcom.getcompania(_form.gettrafcompania());					String correoimportacion = Propiedades.getProperties("correoimportacion");					String texto = informeImportacion(_form.gettrafcodsx());					gem.crea(correoimportacion, "Informe de Recibo Importacion", texto);									}				mensaje = "trafico Actualizado con Exito";				destino = "contenedor_trafico";				request.setAttribute("trafcodsx", _form.gettrafcodsx());			} catch (SQLException e) {				e.printStackTrace();				mensaje = "No se pudo Actualizar el trafico: <br> " + e.getLocalizedMessage();				destino = "trafico_datos";			}		}		// Opcion de eliminar		if (opcion.equals("delete")) {			String codsx = request.getParameter("codsx");			try {				control.eliminar(codsx);				mensaje = "trafico Eliminado con Exito";				destino = "trafico";			} catch (SQLException e) {				e.printStackTrace();				mensaje = "No se pudo Eliminar el trafico: <br> " + e.getLocalizedMessage();				destino = "trafico";			}		}				// Opcion generar pdf de Inspeccion de Recibo		if (opcion.equals("generaPdfInspeccionRecibo")) {			gstinspeccion_recibo ginre = new gstinspeccion_recibo();			 			String trafcodsx = request.getParameter("trafcodsx");			String lctrafcodsx = request.getParameter("lctrafcodsx");;			inspeccion_recibo inre = ginre.getinspeccion_recibo(trafcodsx, lctrafcodsx);			if (inre == null) {				inre = new inspeccion_recibo(trafcodsx, lctrafcodsx);			}			String inremuelle = request.getParameter("inremuelle");			String inreprecinto = request.getParameter("inreprecinto");			String inrevencimiento = request.getParameter("inrevencimiento");			String inrelote = request.getParameter("inrelote");			String inreestibas = request.getParameter("inreestibas");			String inrecajas = request.getParameter("inrecajas");			String inresaldo = request.getParameter("inresaldo");			String inrenovedades = request.getParameter("inrenovedades");			String inrerecuperadas = request.getParameter("inrerecuperadas");			String inretotalump = request.getParameter("inretotalump");			String inreesibasrequeridas = request.getParameter("inreesibasrequeridas");			String inrepesoestibavacia = request.getParameter("inrepesoestibavacia");			String inrepesototalestibasvacias = request.getParameter("inrepesototalestibasvacias");			String inrepesoestibapaletizada = request.getParameter("inrepesoestibapaletizada");			String inrepesoporump = request.getParameter("inrepesoporump");			String inrepesonetoproducto = request.getParameter("inrepesonetoproducto");			String inreobservaciones = request.getParameter("inreobservaciones");			String inrearlvigente_cal = request.getParameter("inrearlvigente_cal");			String inrearlvigente_obs = request.getParameter("inrearlvigente_obs");			String inrecarnet_cal = request.getParameter("inrecarnet_cal");			String inrecarnet_obs = request.getParameter("inrecarnet_obs");			String inreproteccion_cal = request.getParameter("inreproteccion_cal");			String inreproteccion_obs = request.getParameter("inreproteccion_obs");			String inrefumigacion_cal = request.getParameter("inrefumigacion_cal");			String inrefumigacion_obs = request.getParameter("inrefumigacion_obs");			String inremanipulacion_cal = request.getParameter("inremanipulacion_cal");			String inremanipulacion_obs = request.getParameter("inremanipulacion_obs");			String inreaseovehiculo_cal = request.getParameter("inreaseovehiculo_cal");			String inreaseovehiculo_obs = request.getParameter("inreaseovehiculo_obs");			String inresustanciasquimicas_cal = request.getParameter("inresustanciasquimicas_cal");			String inresustanciasquimicas_obs = request.getParameter("inresustanciasquimicas_obs");			String inretemperatura_cal = request.getParameter("inretemperatura_cal");			String inretemperatura_obs = request.getParameter("inretemperatura_obs");			String inreestadogeneral_cal = request.getParameter("inreestadogeneral_cal");			String inreestadogeneral_obs = request.getParameter("inreestadogeneral_obs");			String inrerevisiones_cal = request.getParameter("inrerevisiones_cal");			String inrerevisiones_obs = request.getParameter("inrerevisiones_obs");			String inreumprecibidas_cal = request.getParameter("inreumprecibidas_cal");			String inreumprecibidas_obs = request.getParameter("inreumprecibidas_obs");			String inreumprevisadas_cal = request.getParameter("inreumprevisadas_cal");			String inreumprevisadas_obs = request.getParameter("inreumprevisadas_obs");			String inretablanutricional_cal = request.getParameter("inretablanutricional_cal");			String inretablanutricional_obs = request.getParameter("inretablanutricional_obs");			String inreimportacioncinc_cal = request.getParameter("inreimportacioncinc_cal");			String inreimportacioncinc_obs = request.getParameter("inreimportacioncinc_obs");			String inrecalificacion_cal = request.getParameter("inrecalificacion_cal");			String inrecalificacion_obs = request.getParameter("inrecalificacion_obs");			String inrerecibido = request.getParameter("inrerecibido");			String inreconductor = request.getParameter("inreconductor");			String inrefechagenerado = request.getParameter("inrefechagenerado");			String inreproducto = request.getParameter("inreproducto");			String inrecontenedor = request.getParameter("inrecontenedor");						try {				ginre.eliminar(trafcodsx, lctrafcodsx);							inre.setInremuelle(inremuelle);				ginre.crearinspeccion_recibo(trafcodsx, lctrafcodsx, inremuelle, inreprecinto, 						inrevencimiento, inrelote, inreestibas, inrecajas, inresaldo, 						inrenovedades, inrerecuperadas, inretotalump, inreesibasrequeridas, 						inrepesoestibavacia, inrepesototalestibasvacias, 						inrepesoestibapaletizada, inrepesoporump, inrepesonetoproducto, 						inreobservaciones, inrearlvigente_cal, inrearlvigente_obs, 						inrecarnet_cal, inrecarnet_obs, inreproteccion_cal, 						inreproteccion_obs, inrefumigacion_cal, inrefumigacion_obs, inremanipulacion_cal, 						inremanipulacion_obs, inreaseovehiculo_cal, inreaseovehiculo_obs, 						inresustanciasquimicas_cal, inresustanciasquimicas_obs, inretemperatura_cal, 						inretemperatura_obs, inreestadogeneral_cal, inreestadogeneral_obs, inrerevisiones_cal, 						inrerevisiones_obs, inreumprecibidas_cal, inreumprecibidas_obs, inreumprevisadas_cal, 						inreumprevisadas_obs, inretablanutricional_cal, inretablanutricional_obs, 						inreimportacioncinc_cal, inreimportacioncinc_obs, inrecalificacion_cal, 						inrecalificacion_obs, inrerecibido, inreconductor, inrefechagenerado, inreproducto, inrecontenedor);			} catch (SQLException e1) {				// TODO Auto-generated catch block				e1.printStackTrace();			}			PDFInspeccionRecibo pdf = new PDFInspeccionRecibo();			String rutaContexto = request.getRealPath("")+ File.separator;			String tipoAdjunto = "INSPECCION";			String ruta_pdf = Propiedades.getProperties("ruta_pdf");			String rutaarchivo = rutaContexto + File.separator + ruta_pdf + File.separator + tipoAdjunto + File.separator + trafcodsx;				File file = new File(rutaarchivo);			file.mkdirs();			pdf.pdf(lctrafcodsx, rutaarchivo, "", rutaContexto);						mensaje= "Se generó Inspeccion de Recibo.";								ActionMessages e = getErrors(request);			e.add("general", new ActionMessage(mensaje, false));			addErrors(request, e);			return mapping.findForward("movil_inspeccion");		}				// Opcion enviar correo Cierre de Trafico				if (opcion.equals("cerrar")) {					String trafcodsx = request.getParameter("codsx");						gstenviarmail gem = new gstenviarmail();										try {						trafico entity = control.gettrafico(trafcodsx);						// miro que no este en ningun ingreso:														traficoForm temp = new traficoForm();								temp.setopcion("update");								temp.llenar(entity);								request.setAttribute("traficoForm", temp);								destino = "trafico_datos";								mensaje = "Trafico Activado con exito";																									String correo = "soporte@sli.com.co";						String asunto = "Cierre Trafico No. " +trafcodsx ;						String _mensaje = "Cierre Trafico No. " +trafcodsx + " <br><br> ";						_mensaje = _mensaje + "<table style=\"font-family:arial, helvetica, sans;font-size:70%;align=center; padding: 8px; background: #e8edff;border-bottom: 1px solid #fff; color: #669; border-top: 1px solid transparent;\" >";												if (true) {							mensaje = mensaje + "\r\n" + 									"<tr><td>rESUMEN TRAFICO</td></tr>"; 							/*Iterator iterador=arreglo.iterator();							while(iterador.hasNext()) {								ArrayList arrOfArr=(ArrayList)iterador.next();								Iterator iterador2=arrOfArr.iterator();								while(iterador2.hasNext()){ 									String fila = (String)iterador2. next();									mensaje = mensaje + fila;								}							}*/						} else {							_mensaje = _mensaje + "<tr><td>No hay datos para revisar</td></tr>";						}						_mensaje = mensaje + "</table>";						gem.crea(correo, asunto, mensaje);						//enviarMail_Adjuntos					} catch (SQLException e) {						e.printStackTrace();					}										mensaje= "Se envio correo.";																}						ActionMessages e = getErrors(request);			e.add("general", new ActionMessage(mensaje, false));			addErrors(request, e);			return mapping.findForward(destino);	}		String informeImportacion(String trafcodsx) {		gsttrafico gtraf = new gsttrafico();		gstcontenedor_trafico gcont = new gstcontenedor_trafico();		gstfactura_trafico gfact = new gstfactura_trafico();		gstreferencia_trafico gref = new gstreferencia_trafico();		gstcompania gcomp = new gstcompania();		gsttransportadora gtransp = new gsttransportadora();		gstproducto gprod = new gstproducto();		trafico entity = gtraf.gettrafico(trafcodsx);		compania comp = gcomp.getcompania(entity.gettrafcompania());		transportadora transp = gtransp.gettransportadora(entity.gettraftransportadora());				String texto ="";		texto += "<table style=\"font-family:arial, helvetica, sans;font-size:70%;align=center; padding: 8px; background: #e8edff;border-bottom: 1px solid #fff; color: #669; border-top: 1px solid transparent;\" >";		texto += "<b> Datos Generales </b>";        		texto += "<tr><td><strong>Codigo </strong> <td>" + trafcodsx + "</td>";		texto += "<td><strong>Compania </strong> <td>"+ comp.getcomcodsx() + "  "  + comp.getcomnombre()+ "</td>";		texto += "<td><strong>Fecha Creacion </strong> <td>" + entity.gettraffechacreacion() + "</td>";		texto += "</tr>";		/*        <tr>           <td><strong># Importación  </strong>           <td><bean:write name="entity" property="trafnumdta"/> &nbsp;          <td><strong># BL</strong>           <td><bean:write name="entity" property="trafdocumento"/> &nbsp;           <td><strong>Recibo de Mercancía</strong>          <td><bean:write name="entity" property="trafpedido"/>                   <tr>           <td><strong>Procedencia </strong>           <td><bean:write name="entity" property="trafprocedencia"/> &nbsp;           <td><strong>Fecha Arribo Pto </strong>           <td> <bean:write name="entity" property="traffechaarribopuerto"/> &nbsp;           <td><strong>Origen</strong>          <td> <bean:write name="entity" property="traforigen"/> &nbsp;         <tr>           <td><strong>Sobordo No </strong>           <td><bean:write name="entity" property="trafnumsobordo"/> &nbsp;           <td><strong>Fecha Sobordo</strong>          <td><bean:write name="entity" property="traffechasobordo"/>           <td><strong>Fecha Descargue </strong>           <td><bean:write name="entity" property="traffechadescargue"/>        <tr>                 <td><strong>FOB </strong>           <td align="right"><%= JhFormat.getFormatedNumber( entity.gettraffob() ) %>&nbsp; USD           <td><strong>Fletes y seguro </strong>           <td align="right"><%= JhFormat.getFormatedNumber( entity.gettraffletesseguro() ) %>&nbsp; USD                    <td><strong>CIF </strong>           <td align="right"><%= JhFormat.getFormatedNumber( entity.gettrafcif() ) %>&nbsp; USD        <tr>           <td><strong>TRM </strong>           <td align="right">$ <%= JhFormat.getFormatedNumber( entity.gettraftrm() ) %>&nbsp;           <td><strong>Peso Neto</strong>          <td align="right"><%= JhFormat.getFormatedNumber( entity.gettrafpesoneto() ) %>&nbsp; KGM          <td><strong>Peso Bruto </strong>          <td align="right"><%=  JhFormat.getFormatedNumber(   entity.gettrafpesobruto()  ) %>&nbsp; KGM        <tr>           <td><strong>Cia Transportadora </strong>           <td><%= transp == null ? "&nbsp;" : transp.gettranspnombre()  %>           <td><strong>Observaciones </strong>           <td colspan="5"><bean:write name="entity" property="trafobservaciones"/>             &nbsp;             */		texto += "</table>";            		return texto;	}	}